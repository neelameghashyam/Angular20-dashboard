<div class="fixed bottom-5 right-5 z-60">

  <!-- Floating Chat Bot Icon -->
  <button
    (click)="toggleChat()"
    matTooltipPosition="left"
    class="!fixed bottom-6 right-6 z-50 transition-transform duration-300 ease-in-out hover:scale-110"
    [@scaleIn]
    aria-label="Open chat"
  >
    <img
      src="assets/icons/chat-bot.svg"
      alt="Chat Bot"
      class="w-10 h-10 mt-2 inline-block align-middle"
    />
  </button>

  <!-- Chat Window -->
  <mat-card
    *ngIf="isOpen()"
    [@fadeSlide]
    class="chat-window !fixed !bottom-20 !right-6 !z-40 !shadow-2xl !rounded-xl !overflow-hidden
           !transition-all !duration-300 !ease-in-out !transform !bg-card !text-card-foreground !border !border-gray"
    [ngClass]="{'expanded': isExpanded()}"
    role="dialog"
    aria-label="AIRA Chat"
  >

    <!-- Header -->
    <div class="flex items-center justify-between p-2 border border-border-gray-200 bg-card">
      <div class="flex items-center gap-1.5">
        <img src="assets/icons/chat-bot.svg" alt="Chat Bot" class="w-8 h-8 mt-1" />
        <span class="font-semibold text-sm text-card-foreground">AIRA</span>
      </div>

      <!-- Header Buttons -->
      <div class="flex items-center gap-0.5">
        <!-- Expand Button -->
        <button *ngIf="!isExpanded()" mat-icon-button (click)="expandChat()">
          <mat-icon class="!text-xl !text-foreground">open_in_full</mat-icon>
        </button>

        <!-- Collapse Button -->
        <button *ngIf="isExpanded()" mat-icon-button (click)="collapseChat()">
          <mat-icon class="!text-xl !text-foreground">close_fullscreen</mat-icon>
        </button>

        <!-- Close Button -->
        <button mat-icon-button (click)="toggleChat()">
          <mat-icon class="!text-xl !text-foreground">close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Messages and Feedback Container -->
    <div class="flex flex-col h-full relative">

      <!-- Messages Container -->
      <div
        #messagesContainer
        class="messages-container flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin
               scrollbar-thumb-gray-300 scrollbar-track-transparent"
      >

        <!-- Welcome Message & Quick Options -->
        <div *ngIf="messages().length === 0" class="text-center mt-2" [@slideUp]>
          <p class="font-semibold text-sm mb-3 text-foreground">
            Hello {{ username }},<br />
            What can I help with?
          </p>

          <!-- Quick Action Chips -->
          <div class="flex flex-wrap gap-2 justify-center">
            <button
              *ngFor="let option of quickOptions"
              (click)="sendQuickOption(option)"
              class="px-3 py-1.5 text-xs text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300
                     transition cursor-pointer shadow-sm"
            >
              {{ option }}
            </button>
          </div>
        </div>

        <!-- Chat Messages -->
        <div *ngFor="let msg of messages(); trackBy: trackByMessageId" [@slideUp]>
          <div [ngClass]="msg.sender === 'user' ? 'text-right' : 'text-left'">

            <!-- Message Bubble -->
            <div class="inline-block max-w-[65%]">
              <mat-card
                [ngClass]="
                  msg.sender === 'user'
                    ? '!bg-primary !text-primary-foreground !px-3 !py-1.5 !rounded-full !text-xs
                       !inline-block !shadow-sm'
                    : '!bg-muted !text-muted-foreground !px-3 !py-1.5 !rounded-md !text-xs
                       !inline-block !shadow-sm'
                "
              >
                <!-- Text (default) -->
                <ng-container *ngIf="!msg.type || msg.type === 'text'">
                  <p class="!mb-0 !text-xs !leading-relaxed break-words">{{ msg.text }}</p>
                </ng-container>

                <!-- Link -->
                <ng-container *ngIf="msg.type === 'link'">
                  <a
                    [href]="msg.text"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-blue-600 underline break-words text-xs"
                  >
                    {{ msg.text }}
                  </a>
                </ng-container>

                <!-- Image -->
                <ng-container *ngIf="msg.type === 'image'">
                  <img
                    [src]="msg.text"
                    alt="bot-image"
                    class="rounded-md max-w-[200px] max-h-[150px]"
                  />
                </ng-container>
              </mat-card>
            </div>

            <!-- Bot Message Tools -->
            <div *ngIf="msg.sender === 'bot' && msg.showTools" class="flex items-center gap-0 text-gray-500">
              <!-- Like Button -->
              <button
                mat-icon-button
                (click)="thumbsUp(msg.id)"
                [class]="msg.liked ? '!text-gray-400' : '!text-gray-400'"
              >
                <mat-icon class="!text-s !scale-60">
                  {{ msg.liked ? 'thumb_up' : 'thumb_up_off_alt' }}
                </mat-icon>
              </button>

              <!-- Dislike Button -->
              <button
                mat-icon-button
                (click)="thumbsDown(msg.id)"
                [class]="msg.disliked ? '!text-gray-400' : '!text-gray-400'"
              >
                <mat-icon class="!text-s !scale-60">
                  {{ msg.disliked ? 'thumb_down' : 'thumb_down_off_alt' }}
                </mat-icon>
              </button>

              <!-- Copy Button -->
              <button mat-icon-button class="!text-gray-400 hover:!text-gray-600">
                <mat-icon class="!text-s !scale-60">content_copy</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="awaitingResponse()" class="flex items-center gap-1" [@slideUp]>
          <mat-card
            class="!inline-flex !items-center !bg-gray-200 !text-gray-600 !px-3 !py-1.5 !rounded-full !shadow-sm"
          >
            <div class="flex items-center gap-1">
              <div class="w-1 h-1 bg-gray-500 rounded-full animate-bounce"></div>
              <div class="w-1 h-1 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
              <div class="w-1 h-1 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
            </div>
          </mat-card>
        </div>
      </div>

      <!-- Feedback Box -->
      <mat-card
        *ngIf="showFeedbackBox()"
        class="absolute bottom-13 left-3 right-3 !bg-card border border-border rounded-md
               shadow-sm p-0 z-20"
        style="overflow: hidden;"
      >
        <!-- Feedback Header -->
        <div class="flex justify-between items-center px-2 py-1 border-b border-border bg-card">
          <span class="font-semibold text-card-foreground text-[12px]">
            Provide Additional Feedback
          </span>
          <span class="text-[12px] text-muted-foreground">
            Characters {{ feedbackText().length }}/500
          </span>
        </div>

        <!-- Feedback Textarea -->
        <div class="p-2 bg-card">
          <textarea
            [(ngModel)]="feedbackText"
            placeholder="Type here..."
            maxlength="500"
            rows="2"
            class="w-full border border-border rounded-md p-1.5 text-xs resize-none
                   focus:outline-none focus:ring-1 focus:ring-primary bg-background text-foreground"
          ></textarea>
        </div>

        <!-- Feedback Actions -->
        <div class="flex justify-end gap-1 px-2 py-1 bg-card">
          <!-- Cancel Button -->
          <button
            mat-stroked-button
            (click)="cancelFeedback()"
            class="!text-[10px] !px-2 !py-0.5 !h-auto !rounded-full !border-gray-300
                   !text-[#3E71AD] flex items-center bg-white"
          >
            <mat-icon class="!text-sm !mr-0.5">close</mat-icon>
            Cancel
          </button>

          <!-- Submit Button -->
          <button
            mat-raised-button
            color="primary"
            (click)="submitFeedback()"
            [disabled]="!feedbackText().trim()"
            class="!text-[10px] !px-2 !py-0.5 !h-auto !rounded-full !text-white !text-xs
                   !bg-[#3E71AD] hover:!bg-[#3E71AD] flex items-center"
          >
            <mat-icon class="!text-sm !mr-0.5">done</mat-icon>
            Submit
          </button>
        </div>
      </mat-card>

      <!-- Message Input -->
      <div class="absolute bottom-0 left-0 right-0 border-t border-border p-2 bg-card">
        <div class="flex items-center gap-2 rounded-xl border border-gray-300 bg-card px-3 py-2 shadow-sm">

          <!-- Text Input -->
          <input
            type="text"
            [(ngModel)]="userInput"
            placeholder="Type Here..."
            (keydown)="handleKeyDown($event)"
            [disabled]="awaitingResponse()"
            #messageInput
            class="flex-1 text-sm bg-background text-foreground placeholder-gray-400
                   focus:outline-none disabled:opacity-50 border-none"
          />

          <!-- Send Button -->
          <button
            mat-icon-button
            (click)="sendMessage()"
            [disabled]="!userInput().trim() || awaitingResponse()"
            matTooltip="Send message"
            class="!text-foreground hover:!scale-110 !transition-transform !duration-200 !w-8 !h-8"
          >
            <mat-icon class="!text-sm">
              {{ awaitingResponse() ? 'hourglass_empty' : 'send' }}
            </mat-icon>
          </button>
        </div>
      </div>
    </div>
  </mat-card>
</div>
